import random
import smtplib

class User:
    def __init__(self, username, email, password):
        self.username = username
        self.email = email
        self.password = password
        self.otp = None

class UserManager:
    def __init__(self):
        self.users = {}
        self.load_data()

    def load_data(self):
        try:
            with open('data.txt', 'r') as file:
                for line in file:
                    username, email, password = line.strip().split(',')
                    self.users[username] = User(username, email, password)
        except FileNotFoundError:
            pass
        except Exception as e:
            print("An error occurred while loading data:", e)

    def save_data(self):
        try:
            with open('data.txt', 'w') as file:
                for user in self.users.values():
                    file.write(f"{user.username},{user.email},{user.password}\n")
        except Exception as e:
            print("An error occurred while saving data:", e)

    def login(self):
        username = input("Enter username: ").strip()
        password = input("Enter password: ").strip()
        if username in self.users and self.users[username].password == password:
            print("Login successful!")
        else:
            print("Username or password incorrect.")
            choice = input("Forgot password? (yes/no): ").strip().lower()
            if choice == 'yes':
                self.forgot_password(username)
            else:
                choice = input("Do you want to sign in (yes/no): ").strip().lower()
                if choice == 'yes':
                    self.forgot_password(username)
                else:
                    print("good bye")
                    
    

    def forgot_password(self, username):
        if username in self.users:
            user = self.users[username]
            otp = self.generate_otp()
            self.send_otp(user.email, otp)
            user.otp = otp
            self.verify_otp(username)
        else:
            print("Username not found.")

    def generate_otp(self):
        return str(random.randint(1000, 9999))

    def send_otp(self, email, otp):
        # Dummy function to simulate sending OTP via email
        print(f"An OTP has been sent to {email}: {otp}")

    def verify_otp(self, username):
        otp = input("Enter OTP: ").strip()
        if username in self.users and self.users[username].otp == otp:
            print("OTP verification successful!")
            new_password = input("Enter new password: ").strip()
            self.users[username].password = new_password
            self.users[username].otp = None
            self.save_data()
            print("Password reset successful!")
        else:
            print("OTP verification failed. Please try again.")

    def signup(self):
        while True:
            username = input("Enter username: ").strip()
            email = input("Enter email: ").strip()
            password = input("Enter password: ").strip()

            if not (username and email and password):
                print("Please enter valid values for username, email, and password.")
                continue

            if username in self.users:
                print("Username already exists. Please choose another.")
            else:
                self.users[username] = User(username, email, password)
                self.save_data()
                print("Sign up successful!")
                break

if __name__ == "__main__":
    userManager = UserManager()
    userManager.login()